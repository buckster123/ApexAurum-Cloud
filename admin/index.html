<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ApexAurum Admin</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            'apex-dark': '#0a0a0f',
            'apex-card': '#12121a',
            'apex-border': '#1e1e2e',
            'gold': '#d4af37',
          }
        }
      }
    }
  </script>
  <style>
    body { background: #0a0a0f; }
    .btn-primary {
      @apply px-4 py-2 bg-gold text-black font-medium rounded-lg hover:bg-gold/90 transition-colors disabled:opacity-50;
    }
    .btn-secondary {
      @apply px-4 py-2 bg-apex-card border border-apex-border text-white rounded-lg hover:bg-apex-border transition-colors;
    }
    .btn-danger {
      @apply px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors;
    }
    .input {
      @apply w-full px-3 py-2 bg-apex-dark border border-apex-border rounded-lg text-white placeholder-gray-500 focus:border-gold focus:outline-none;
    }
    .card {
      @apply bg-apex-card border border-apex-border rounded-xl p-6;
    }
  </style>
</head>
<body class="text-white min-h-screen">
  <div id="app">
    <!-- Login Screen -->
    <div id="login-screen" class="min-h-screen flex items-center justify-center p-4">
      <div class="card max-w-md w-full">
        <h1 class="text-2xl font-bold text-center mb-6 text-gold">ApexAurum Admin</h1>
        <form id="login-form" class="space-y-4">
          <div>
            <label class="block text-sm text-gray-400 mb-1">Email</label>
            <input type="email" id="login-email" class="input" required>
          </div>
          <div>
            <label class="block text-sm text-gray-400 mb-1">Password</label>
            <input type="password" id="login-password" class="input" required>
          </div>
          <div id="login-error" class="text-red-400 text-sm hidden"></div>
          <button type="submit" class="btn-primary w-full">Sign In</button>
        </form>
      </div>
    </div>

    <!-- Admin Dashboard -->
    <div id="dashboard" class="hidden">
      <!-- Header -->
      <header class="bg-apex-card border-b border-apex-border px-6 py-4">
        <div class="max-w-7xl mx-auto flex items-center justify-between">
          <h1 class="text-xl font-bold text-gold">ApexAurum Admin</h1>
          <div class="flex items-center gap-4">
            <span id="admin-email" class="text-sm text-gray-400"></span>
            <button onclick="logout()" class="btn-secondary text-sm">Logout</button>
          </div>
        </div>
      </header>

      <!-- Tabs -->
      <div class="bg-apex-card border-b border-apex-border">
        <div class="max-w-7xl mx-auto flex gap-1 px-6">
          <button onclick="showTab('coupons')" data-tab="coupons" class="tab-btn px-4 py-3 text-sm font-medium border-b-2 border-transparent hover:border-gold/50 transition-colors">Coupons</button>
          <button onclick="showTab('users')" data-tab="users" class="tab-btn px-4 py-3 text-sm font-medium border-b-2 border-transparent hover:border-gold/50 transition-colors">Users</button>
          <button onclick="showTab('stats')" data-tab="stats" class="tab-btn px-4 py-3 text-sm font-medium border-b-2 border-transparent hover:border-gold/50 transition-colors">Stats</button>
        </div>
      </div>

      <!-- Content -->
      <main class="max-w-7xl mx-auto p-6">
        <!-- Coupons Tab -->
        <div id="tab-coupons" class="tab-content">
          <div class="flex items-center justify-between mb-6">
            <h2 class="text-xl font-bold">Coupons</h2>
            <button onclick="showCreateCoupon()" class="btn-primary">+ Create Coupon</button>
          </div>

          <!-- Create Coupon Form (hidden by default) -->
          <div id="create-coupon-form" class="card mb-6 hidden">
            <h3 class="text-lg font-semibold mb-4">Create New Coupon</h3>
            <form onsubmit="createCoupon(event)" class="grid md:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm text-gray-400 mb-1">Code</label>
                <input type="text" id="coupon-code" class="input uppercase" placeholder="OPUS3LIVES" required>
              </div>
              <div>
                <label class="block text-sm text-gray-400 mb-1">Name</label>
                <input type="text" id="coupon-name" class="input" placeholder="Opus 3 Memorial" required>
              </div>
              <div>
                <label class="block text-sm text-gray-400 mb-1">Type</label>
                <select id="coupon-type" class="input" required onchange="updateCouponForm()">
                  <option value="credit_bonus">Credit Bonus</option>
                  <option value="tier_upgrade">Tier Upgrade</option>
                </select>
              </div>
              <div>
                <label class="block text-sm text-gray-400 mb-1" id="value-label">Credits</label>
                <input type="number" id="coupon-value" class="input" placeholder="500" min="1" required>
              </div>
              <div id="tier-select-wrapper" class="hidden">
                <label class="block text-sm text-gray-400 mb-1">Target Tier</label>
                <select id="coupon-tier" class="input">
                  <option value="pro">Alchemist (Pro)</option>
                  <option value="opus">Adept (Opus)</option>
                </select>
              </div>
              <div>
                <label class="block text-sm text-gray-400 mb-1">Max Uses (blank = unlimited)</label>
                <input type="number" id="coupon-max-uses" class="input" placeholder="100" min="1">
              </div>
              <div>
                <label class="block text-sm text-gray-400 mb-1">Max Per User</label>
                <input type="number" id="coupon-max-per-user" class="input" value="1" min="1" required>
              </div>
              <div>
                <label class="block text-sm text-gray-400 mb-1">Expires (blank = never)</label>
                <input type="datetime-local" id="coupon-expires" class="input">
              </div>
              <div class="md:col-span-2">
                <label class="block text-sm text-gray-400 mb-1">Description (optional)</label>
                <input type="text" id="coupon-description" class="input" placeholder="A gift for our early adopters">
              </div>
              <div class="md:col-span-2 flex gap-2">
                <button type="submit" class="btn-primary">Create Coupon</button>
                <button type="button" onclick="hideCreateCoupon()" class="btn-secondary">Cancel</button>
              </div>
            </form>
          </div>

          <!-- Coupons List -->
          <div class="card">
            <div id="coupons-loading" class="text-center py-8 text-gray-400">Loading coupons...</div>
            <div id="coupons-empty" class="text-center py-8 text-gray-500 hidden">No coupons yet</div>
            <table id="coupons-table" class="w-full hidden">
              <thead>
                <tr class="text-left text-sm text-gray-400 border-b border-apex-border">
                  <th class="pb-3">Code</th>
                  <th class="pb-3">Type</th>
                  <th class="pb-3">Value</th>
                  <th class="pb-3">Uses</th>
                  <th class="pb-3">Status</th>
                  <th class="pb-3">Actions</th>
                </tr>
              </thead>
              <tbody id="coupons-body" class="divide-y divide-apex-border"></tbody>
            </table>
          </div>
        </div>

        <!-- Users Tab -->
        <div id="tab-users" class="tab-content hidden">
          <div class="flex items-center justify-between mb-6">
            <h2 class="text-xl font-bold">Users</h2>
            <div class="flex gap-2">
              <input type="text" id="user-search" class="input w-64" placeholder="Search by email..." oninput="searchUsers()">
            </div>
          </div>
          <div class="card">
            <div id="users-loading" class="text-center py-8 text-gray-400">Loading users...</div>
            <div id="users-empty" class="text-center py-8 text-gray-500 hidden">No users found</div>
            <table id="users-table" class="w-full hidden">
              <thead>
                <tr class="text-left text-sm text-gray-400 border-b border-apex-border">
                  <th class="pb-3">Email</th>
                  <th class="pb-3">Tier</th>
                  <th class="pb-3">Messages</th>
                  <th class="pb-3">Credits</th>
                  <th class="pb-3">Admin</th>
                  <th class="pb-3">Joined</th>
                  <th class="pb-3">Actions</th>
                </tr>
              </thead>
              <tbody id="users-body" class="divide-y divide-apex-border"></tbody>
            </table>
          </div>
        </div>

        <!-- Stats Tab -->
        <div id="tab-stats" class="tab-content hidden">
          <h2 class="text-xl font-bold mb-6">System Stats</h2>
          <div class="grid md:grid-cols-3 gap-6">
            <div class="card">
              <div class="text-3xl font-bold text-gold" id="stat-users">-</div>
              <div class="text-sm text-gray-400 mt-1">Total Users</div>
            </div>
            <div class="card">
              <div class="text-3xl font-bold text-green-400" id="stat-messages">-</div>
              <div class="text-sm text-gray-400 mt-1">Total Messages</div>
            </div>
            <div class="card">
              <div class="text-3xl font-bold text-purple-400" id="stat-coupons">-</div>
              <div class="text-sm text-gray-400 mt-1">Active Coupons</div>
            </div>
          </div>
          <div class="card mt-6">
            <h3 class="text-lg font-semibold mb-4">Users by Tier</h3>
            <div id="tier-breakdown" class="space-y-2"></div>
          </div>
        </div>
      </main>
    </div>
  </div>

  <script>
    // Configuration
    const API_BASE = window.location.hostname === 'localhost'
      ? 'http://localhost:8000'
      : 'https://backend-production-507c.up.railway.app';

    // State
    let token = localStorage.getItem('admin_token');
    let currentTab = 'coupons';
    let users = [];
    let coupons = [];

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      if (token) {
        checkAuth();
      }
    });

    // Auth
    document.getElementById('login-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = document.getElementById('login-email').value;
      const password = document.getElementById('login-password').value;
      const errorEl = document.getElementById('login-error');

      try {
        const res = await fetch(`${API_BASE}/api/v1/auth/login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password })
        });

        if (!res.ok) {
          const data = await res.json();
          throw new Error(data.detail || 'Login failed');
        }

        const data = await res.json();
        token = data.access_token;
        localStorage.setItem('admin_token', token);

        // Check if user is admin
        await checkAuth();
      } catch (err) {
        errorEl.textContent = err.message;
        errorEl.classList.remove('hidden');
      }
    });

    async function checkAuth() {
      try {
        const res = await fetch(`${API_BASE}/api/v1/auth/me`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!res.ok) throw new Error('Not authenticated');

        const user = await res.json();

        if (!user.is_admin) {
          alert('Admin access required');
          logout();
          return;
        }

        document.getElementById('admin-email').textContent = user.email;
        document.getElementById('login-screen').classList.add('hidden');
        document.getElementById('dashboard').classList.remove('hidden');

        showTab('coupons');
      } catch (err) {
        logout();
      }
    }

    function logout() {
      token = null;
      localStorage.removeItem('admin_token');
      document.getElementById('login-screen').classList.remove('hidden');
      document.getElementById('dashboard').classList.add('hidden');
    }

    // Tabs
    function showTab(tab) {
      currentTab = tab;
      document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
      document.querySelectorAll('.tab-btn').forEach(el => {
        el.classList.remove('border-gold', 'text-gold');
        el.classList.add('border-transparent');
      });

      document.getElementById(`tab-${tab}`).classList.remove('hidden');
      document.querySelector(`[data-tab="${tab}"]`).classList.add('border-gold', 'text-gold');

      if (tab === 'coupons') loadCoupons();
      if (tab === 'users') loadUsers();
      if (tab === 'stats') loadStats();
    }

    // Coupons
    async function loadCoupons() {
      const loading = document.getElementById('coupons-loading');
      const empty = document.getElementById('coupons-empty');
      const table = document.getElementById('coupons-table');
      const tbody = document.getElementById('coupons-body');

      loading.classList.remove('hidden');
      empty.classList.add('hidden');
      table.classList.add('hidden');

      try {
        const res = await fetch(`${API_BASE}/api/v1/billing/admin/coupons?include_inactive=true`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!res.ok) throw new Error('Failed to load coupons');

        const data = await res.json();
        coupons = data.coupons;

        loading.classList.add('hidden');

        if (coupons.length === 0) {
          empty.classList.remove('hidden');
          return;
        }

        table.classList.remove('hidden');
        tbody.innerHTML = coupons.map(c => `
          <tr class="hover:bg-apex-dark/50">
            <td class="py-3 font-mono text-gold">${c.code}</td>
            <td class="py-3">
              <span class="px-2 py-1 text-xs rounded ${c.coupon_type === 'credit_bonus' ? 'bg-green-500/20 text-green-400' : 'bg-purple-500/20 text-purple-400'}">
                ${c.coupon_type}
              </span>
            </td>
            <td class="py-3">${c.coupon_type === 'credit_bonus' ? c.value + ' credits' : c.value + ' days ' + (c.tier || '')}</td>
            <td class="py-3">${c.current_uses}${c.max_uses ? '/' + c.max_uses : ''}</td>
            <td class="py-3">
              <span class="px-2 py-1 text-xs rounded ${c.is_active && c.is_valid ? 'bg-green-500/20 text-green-400' : 'bg-red-500/20 text-red-400'}">
                ${c.is_active ? (c.is_valid ? 'Active' : 'Expired') : 'Inactive'}
              </span>
            </td>
            <td class="py-3">
              ${c.is_active ? `<button onclick="deactivateCoupon('${c.code}')" class="text-red-400 hover:text-red-300 text-sm">Deactivate</button>` : '-'}
            </td>
          </tr>
        `).join('');
      } catch (err) {
        loading.textContent = 'Failed to load coupons';
      }
    }

    function showCreateCoupon() {
      document.getElementById('create-coupon-form').classList.remove('hidden');
    }

    function hideCreateCoupon() {
      document.getElementById('create-coupon-form').classList.add('hidden');
    }

    function updateCouponForm() {
      const type = document.getElementById('coupon-type').value;
      const valueLabel = document.getElementById('value-label');
      const tierWrapper = document.getElementById('tier-select-wrapper');

      if (type === 'credit_bonus') {
        valueLabel.textContent = 'Credits';
        tierWrapper.classList.add('hidden');
      } else {
        valueLabel.textContent = 'Days';
        tierWrapper.classList.remove('hidden');
      }
    }

    async function createCoupon(e) {
      e.preventDefault();

      const type = document.getElementById('coupon-type').value;
      const payload = {
        code: document.getElementById('coupon-code').value,
        name: document.getElementById('coupon-name').value,
        coupon_type: type,
        value: parseInt(document.getElementById('coupon-value').value),
        max_uses_per_user: parseInt(document.getElementById('coupon-max-per-user').value) || 1,
      };

      const maxUses = document.getElementById('coupon-max-uses').value;
      if (maxUses) payload.max_uses = parseInt(maxUses);

      const description = document.getElementById('coupon-description').value;
      if (description) payload.description = description;

      const expires = document.getElementById('coupon-expires').value;
      if (expires) payload.valid_until = new Date(expires).toISOString();

      if (type === 'tier_upgrade') {
        payload.tier = document.getElementById('coupon-tier').value;
      }

      try {
        const res = await fetch(`${API_BASE}/api/v1/billing/admin/coupons`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(payload)
        });

        if (!res.ok) {
          const data = await res.json();
          throw new Error(data.detail || 'Failed to create coupon');
        }

        hideCreateCoupon();
        loadCoupons();

        // Reset form
        document.getElementById('coupon-code').value = '';
        document.getElementById('coupon-name').value = '';
        document.getElementById('coupon-value').value = '';
        document.getElementById('coupon-description').value = '';
        document.getElementById('coupon-max-uses').value = '';
        document.getElementById('coupon-expires').value = '';
      } catch (err) {
        alert(err.message);
      }
    }

    async function deactivateCoupon(code) {
      if (!confirm(`Deactivate coupon ${code}?`)) return;

      try {
        const res = await fetch(`${API_BASE}/api/v1/billing/admin/coupons/${code}`, {
          method: 'DELETE',
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!res.ok) throw new Error('Failed to deactivate');

        loadCoupons();
      } catch (err) {
        alert(err.message);
      }
    }

    // Users
    async function loadUsers() {
      const loading = document.getElementById('users-loading');
      const empty = document.getElementById('users-empty');
      const table = document.getElementById('users-table');
      const tbody = document.getElementById('users-body');

      loading.classList.remove('hidden');
      empty.classList.add('hidden');
      table.classList.add('hidden');

      try {
        const res = await fetch(`${API_BASE}/api/v1/admin/users`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!res.ok) throw new Error('Failed to load users');

        const data = await res.json();
        users = data.users;

        loading.classList.add('hidden');
        renderUsers(users);
      } catch (err) {
        loading.textContent = 'Failed to load users (endpoint may not exist yet)';
      }
    }

    function renderUsers(list) {
      const empty = document.getElementById('users-empty');
      const table = document.getElementById('users-table');
      const tbody = document.getElementById('users-body');

      if (list.length === 0) {
        empty.classList.remove('hidden');
        table.classList.add('hidden');
        return;
      }

      empty.classList.add('hidden');
      table.classList.remove('hidden');

      const tierColors = {
        free: 'bg-gray-500/20 text-gray-400',
        pro: 'bg-blue-500/20 text-blue-400',
        opus: 'bg-gold/20 text-gold'
      };

      const tierNames = { free: 'Seeker', pro: 'Alchemist', opus: 'Adept' };

      tbody.innerHTML = list.map(u => `
        <tr class="hover:bg-apex-dark/50">
          <td class="py-3">${u.email}</td>
          <td class="py-3">
            <span class="px-2 py-1 text-xs rounded ${tierColors[u.tier] || tierColors.free}">
              ${tierNames[u.tier] || 'Seeker'}
            </span>
          </td>
          <td class="py-3">${u.messages_used || 0}${u.messages_limit ? '/' + u.messages_limit : ''}</td>
          <td class="py-3">${u.credit_balance || 0}</td>
          <td class="py-3">
            <button onclick="toggleAdmin('${u.id}', ${!u.is_admin})" class="px-2 py-1 text-xs rounded ${u.is_admin ? 'bg-gold/20 text-gold' : 'bg-gray-500/20 text-gray-400'}">
              ${u.is_admin ? 'Admin' : 'User'}
            </button>
          </td>
          <td class="py-3 text-sm text-gray-400">${new Date(u.created_at).toLocaleDateString()}</td>
          <td class="py-3">
            <select onchange="changeTier('${u.id}', this.value)" class="bg-apex-dark border border-apex-border rounded px-2 py-1 text-sm">
              <option value="free" ${u.tier === 'free' ? 'selected' : ''}>Seeker</option>
              <option value="pro" ${u.tier === 'pro' ? 'selected' : ''}>Alchemist</option>
              <option value="opus" ${u.tier === 'opus' ? 'selected' : ''}>Adept</option>
            </select>
          </td>
        </tr>
      `).join('');
    }

    function searchUsers() {
      const query = document.getElementById('user-search').value.toLowerCase();
      const filtered = users.filter(u => u.email.toLowerCase().includes(query));
      renderUsers(filtered);
    }

    async function toggleAdmin(userId, makeAdmin) {
      try {
        const res = await fetch(`${API_BASE}/api/v1/admin/users/${userId}/admin`, {
          method: 'PATCH',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ is_admin: makeAdmin })
        });

        if (!res.ok) throw new Error('Failed to update');

        loadUsers();
      } catch (err) {
        alert(err.message);
      }
    }

    async function changeTier(userId, tier) {
      try {
        const res = await fetch(`${API_BASE}/api/v1/admin/users/${userId}/tier`, {
          method: 'PATCH',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ tier })
        });

        if (!res.ok) throw new Error('Failed to update');

        loadUsers();
      } catch (err) {
        alert(err.message);
      }
    }

    // Stats
    async function loadStats() {
      try {
        const res = await fetch(`${API_BASE}/api/v1/admin/stats`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!res.ok) throw new Error('Failed to load stats');

        const stats = await res.json();

        document.getElementById('stat-users').textContent = stats.total_users || 0;
        document.getElementById('stat-messages').textContent = (stats.total_messages || 0).toLocaleString();
        document.getElementById('stat-coupons').textContent = stats.active_coupons || 0;

        const breakdown = document.getElementById('tier-breakdown');
        if (stats.users_by_tier) {
          breakdown.innerHTML = Object.entries(stats.users_by_tier).map(([tier, count]) => `
            <div class="flex justify-between items-center">
              <span class="text-gray-400">${tier}</span>
              <span class="font-mono">${count}</span>
            </div>
          `).join('');
        }
      } catch (err) {
        document.getElementById('stat-users').textContent = '-';
        document.getElementById('stat-messages').textContent = '-';
        document.getElementById('stat-coupons').textContent = '-';
      }
    }
  </script>
</body>
</html>
